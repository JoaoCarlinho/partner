// Prisma Schema for Steno Demand Letter Platform
// Epic 1: Foundation - User Authentication

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  FIRM_ADMIN
  ATTORNEY
  PARALEGAL
  DEBTOR
  PUBLIC_DEFENDER
}

enum CaseStatus {
  ACTIVE
  RESOLVED
  ESCALATED
  CLOSED
}

enum LetterStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  SENT
}

enum PlanStatus {
  PROPOSED
  COUNTERED
  ACCEPTED
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum Frequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

// ============================================
// CORE MODELS - Epic 1: Foundation
// ============================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users       User[]
  invites     OrganizationInvite[]
  templates   Template[]
  cases       Case[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String   @unique
  passwordHash   String   @map("password_hash")
  role           Role     @default(PARALEGAL)
  emailVerified  Boolean  @default(false) @map("email_verified")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization           Organization             @relation(fields: [organizationId], references: [id])
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens    PasswordResetToken[]
  sessions               Session[]
  auditLogs              AuditLog[]
  templatesCreated       Template[]               @relation("TemplateCreator")
  letterVersionsCreated  DemandLetterVersion[]

  @@index([organizationId])
  @@map("users")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@map("password_reset_tokens")
}

model OrganizationInvite {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String
  role           Role     @default(PARALEGAL)
  inviteCode     String   @unique @map("invite_code")
  expiresAt      DateTime @map("expires_at")
  acceptedAt     DateTime? @map("accepted_at")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([inviteCode])
  @@map("organization_invites")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  tokenHash    String   @unique @map("token_hash")
  csrfToken    String   @map("csrf_token")
  expiresAt    DateTime @map("expires_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model AuditLog {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  organizationId String? @map("organization_id")
  action        String
  entityType    String?  @map("entity_type")
  entityId      String?  @map("entity_id")
  metadata      Json?
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// TEMPLATES - Epic 2: Demand Generation
// ============================================

model Template {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  content        String
  variables      Json     @default("[]")
  isActive       Boolean  @default(true) @map("is_active")
  version        Int      @default(1)
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization  Organization      @relation(fields: [organizationId], references: [id])
  creator       User              @relation("TemplateCreator", fields: [createdBy], references: [id])
  demandLetters DemandLetter[]
  versions      TemplateVersion[]

  @@unique([organizationId, name])
  @@index([organizationId, isActive])
  @@map("templates")
}

model TemplateVersion {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  version    Int
  content    String
  variables  Json
  createdAt  DateTime @default(now()) @map("created_at")

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@map("template_versions")
}

// ============================================
// CASES & DEMAND LETTERS - Epic 2 & 3
// ============================================

model Case {
  id             String     @id @default(uuid())
  organizationId String     @map("organization_id")
  debtorUserId   String?    @map("debtor_user_id")
  status         CaseStatus @default(ACTIVE)
  debtAmount     Decimal    @map("debt_amount") @db.Decimal(12, 2)
  creditorName   String     @map("creditor_name")
  debtorName     String?    @map("debtor_name")
  debtorEmail    String?    @map("debtor_email")
  metadata       Json?
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  organization  Organization   @relation(fields: [organizationId], references: [id])
  demandLetters DemandLetter[]
  messages      Message[]
  paymentPlans  PaymentPlan[]
  debtorProfile DebtorProfile?

  @@index([organizationId])
  @@index([status])
  @@map("cases")
}

model DemandLetter {
  id                      String       @id @default(uuid())
  organizationId          String       @map("organization_id")
  caseId                  String       @map("case_id")
  templateId              String?      @map("template_id")
  content                 String
  paraphrasedContent      String?      @map("paraphrased_content")
  complianceResult        Json?        @map("compliance_result")
  status                  LetterStatus @default(DRAFT)
  currentVersion          Int          @default(1) @map("current_version")
  invitationToken         String?      @unique @map("invitation_token")
  invitationTokenId       String?      @unique @map("invitation_token_id")
  invitationExpiresAt     DateTime?    @map("invitation_expires_at")
  invitationUsageLimit    Int          @default(1) @map("invitation_usage_limit")
  invitationUsageCount    Int          @default(0) @map("invitation_usage_count")
  invitationRevokedAt     DateTime?    @map("invitation_revoked_at")
  invitationCreatedAt     DateTime?    @map("invitation_created_at")
  invitationPayload       Json?        @map("invitation_payload")
  sentAt                  DateTime?    @map("sent_at")
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")

  case     Case      @relation(fields: [caseId], references: [id])
  template Template? @relation(fields: [templateId], references: [id])
  versions DemandLetterVersion[]

  @@index([caseId])
  @@index([invitationToken])
  @@index([invitationTokenId])
  @@map("demand_letters")
}

model DemandLetterVersion {
  id                    String   @id @default(uuid())
  demandLetterId        String   @map("demand_letter_id")
  version               Int
  content               String
  refinementInstruction String?  @map("refinement_instruction")
  complianceResult      Json?    @map("compliance_result")
  createdBy             String   @map("created_by")
  createdAt             DateTime @default(now()) @map("created_at")

  demandLetter DemandLetter @relation(fields: [demandLetterId], references: [id], onDelete: Cascade)
  creator      User         @relation(fields: [createdBy], references: [id])

  @@unique([demandLetterId, version])
  @@index([demandLetterId])
  @@map("demand_letter_versions")
}

// ============================================
// MESSAGING - Epic 4: Communication
// ============================================

model Message {
  id              String    @id @default(uuid())
  caseId          String    @map("case_id")
  senderId        String    @map("sender_id")
  senderRole      Role      @map("sender_role")
  content         String
  originalContent String?   @map("original_content")
  toneAnalysis    Json?     @map("tone_analysis")
  createdAt       DateTime  @default(now()) @map("created_at")
  readAt          DateTime? @map("read_at")

  case Case @relation(fields: [caseId], references: [id])

  @@index([caseId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// PAYMENT PLANS - Epic 5: Resolution
// ============================================

model PaymentPlan {
  id            String     @id @default(uuid())
  caseId        String     @map("case_id")
  totalAmount   Decimal    @map("total_amount") @db.Decimal(12, 2)
  downPayment   Decimal    @default(0) @map("down_payment") @db.Decimal(12, 2)
  paymentAmount Decimal    @map("payment_amount") @db.Decimal(12, 2)
  frequency     Frequency
  startDate     DateTime   @map("start_date")
  status        PlanStatus @default(PROPOSED)
  proposedBy    Role       @map("proposed_by")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  case     Case      @relation(fields: [caseId], references: [id])
  payments Payment[]

  @@index([caseId])
  @@index([status])
  @@map("payment_plans")
}

model Payment {
  id            String   @id @default(uuid())
  paymentPlanId String   @map("payment_plan_id")
  amount        Decimal  @db.Decimal(12, 2)
  dueDate       DateTime @map("due_date")
  paidAt        DateTime? @map("paid_at")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  paymentPlan PaymentPlan @relation(fields: [paymentPlanId], references: [id])

  @@index([paymentPlanId])
  @@map("payments")
}

// ============================================
// INTELLIGENCE - Epic 6: Pattern Learning
// ============================================

model DebtorProfile {
  id         String   @id @default(uuid())
  caseId     String   @unique @map("case_id")
  assessment Json?
  outcome    String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  case Case @relation(fields: [caseId], references: [id])

  @@map("debtor_profiles")
}

// Note: Vector embeddings will be added via raw SQL migration
// using pgvector extension: embedding vector(1536)
